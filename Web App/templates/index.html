<html>
<head>
    <script type="text/javascript">console.log("Executed before socket script")</script>
    <meta name="viewport" content="width=1000; user-scalable=0;" />
    <title>App for visually impaired</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        #container {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #container video {
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        #video {
            transform: rotateY(180deg);
        }
    </style>
    <link rel="shortcut icon" href="">
</head>
<body>
    <div id="container">
        <video autoplay playsinline id="videoElement"></video>
        <canvas id="canvas" width="400" height="300" hidden></canvas>
    </div>

    <script src="https://cdn.socket.io/4.5.3/socket.io.min.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js" crossorigin="anonymous"></script>

    <audio id="left" src="/static/audio/MoveLeft.wav" type="audio/mp3"></audio>
    <audio id="right" src="/static/audio/MoveRight.mp3" type="audio/mp3"></audio>
    <audio id="sright" src="/static/audio/MoveSlightlyRi.mp3" type="audio/mp3"></audio>
    <audio id="sleft" src="/static/audio/MoveSlightlyLe.mp3" type="audio/mp3"></audio>
    <audio id="stop" src="/static/audio/Stop.mp3" type="audio/mp3"></audio>
    <audio id="straight" src="/static/audio/MoveStraight.mp3" type="audio/mp3"></audio>

    <script type="text/javascript">
        var currentAudio = null;

        var socket = io("https://visually-impaired-quac57d7d-arpits-projects-6a697863.vercel.app/", {
            transports: ['polling']
        });

        socket.on('connect', function() {
            console.log("Connected to server:", socket.connected);
        });

        socket.on('connect_error', (err) => {
            console.error("Connection error:", err);
        });

        socket.on('disconnect', () => {
            console.warn("Socket disconnected. Retrying...");
        });

        const video = document.querySelector("#videoElement");
        video.width = 400;
        video.height = 300;

        if (navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(function(stream) {
                    video.srcObject = stream;
                    video.play();
                })
                .catch(function(error) {
                    console.error("Error accessing camera:", error);
                });
        }

        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const FPS = 6;
        setInterval(() => {
            context.drawImage(video, 0, 0, video.width, video.height);
            const data = canvas.toDataURL('image/jpeg', 0.5);
            context.clearRect(0, 0, video.width, video.height);
            socket.emit('image', data);
        }, 1000 / FPS);

        socket.on('response_back', function(vibe) {
            let audioId;
            switch (vibe.data) {
                case "l":
                    audioId = 'left';
                    break;
                case "r":
                    audioId = 'right';
                    break;
                case "stop":
                    audioId = 'stop';
                    break;
                case "sr":
                    audioId = 'sright';
                    break;
                case "sl":
                    audioId = 'sleft';
                    break;
                case "straight":
                    audioId = 'straight';
                    break;
                default:
                    return;
            }
            playAudio(audioId);
        });

        async function playAudio(id) {
            const audioElement = document.getElementById(id);
            if (!audioElement) {
                console.error('Audio element not found');
                return;
            }
            if (currentAudio && !currentAudio.paused) {
                currentAudio.pause();
                currentAudio.currentTime = 0; // Reset to start
            }
            currentAudio = audioElement;
            try {
                await currentAudio.play();
            } catch (error) {
                console.error('Error playing audio:', error);
            }
        }
    </script>
</body>
</html>
